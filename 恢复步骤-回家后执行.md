# 恢复步骤清单（回家后执行）

## 第一步：停止并卸载 nginx

```bash
# 1. 停止 nginx
sudo systemctl stop nginx
sudo systemctl disable nginx

# 2. 卸载 nginx
sudo apt remove nginx nginx-common  # Ubuntu/Debian
# 或
sudo yum remove nginx  # CentOS/RHEL

# 3. 删除 nginx 配置（如果有）
sudo rm -rf /etc/nginx/sites-enabled/pt-gen
sudo rm -rf /etc/nginx/sites-available/pt-gen
```

## 第二步：恢复 SSH 和飞牛控制台

```bash
# 1. 重启 SSH 服务
sudo systemctl restart ssh || sudo systemctl restart sshd
sudo systemctl enable ssh || sudo systemctl enable sshd

# 2. 检查 SSH 状态
sudo systemctl status ssh || sudo systemctl status sshd
netstat -tlnp | grep :22

# 3. 重启 FNOS 服务
sudo systemctl restart fnos
# 或根据实际服务名
sudo systemctl status | grep fnos

# 4. 检查飞牛控制台端口
netstat -tlnp | grep :5666
```

## 第三步：检查防火墙

```bash
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 22/tcp
sudo ufw allow 5666/tcp

# CentOS/RHEL
sudo firewall-cmd --list-all
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=5666/tcp
sudo firewall-cmd --reload
```

## 第四步：验证恢复

```bash
# 1. 测试 SSH（从其他机器）
ssh root@192.168.2.13

# 2. 测试飞牛控制台
curl http://192.168.2.13:5666
# 或在浏览器访问 http://192.168.2.13:5666
```

## 第五步：配置服务外部访问（正确方式）

### 方式一：使用 socat（推荐，简单）

```bash
# 1. 安装 socat
sudo apt install socat  # Ubuntu/Debian
# 或
sudo yum install socat  # CentOS/RHEL

# 2. 启动服务（如果还没启动）
cd ~/PT-Gen-Refactor
npm run dev &

# 3. 使用 socat 转发端口
socat TCP-LISTEN:8787,fork,reuseaddr,bind=0.0.0.0 TCP:127.0.0.1:8787 &

# 4. 测试
curl http://192.168.2.13:8787
```

### 方式二：通过 FNOS 控制台配置反向代理

1. 登录 FNOS 控制台（http://192.168.2.13:5666）
2. 找到"应用管理"或"反向代理"功能
3. 添加规则：
   - 外部端口：8787
   - 内部地址：127.0.0.1:8787
   - 协议：HTTP

### 方式三：使用 PM2 管理服务（可选）

```bash
# 安装 PM2
npm install -g pm2

# 启动服务
cd ~/PT-Gen-Refactor
pm2 start npm --name "pt-gen" -- run dev

# 查看状态
pm2 status
pm2 logs pt-gen
```

## 注意事项

1. **不要安装 nginx** - FNOS 有自己的代理系统，安装 nginx 会导致冲突
2. **使用 socat 或 FNOS 控制台** - 这两种方式不会影响系统服务
3. **测试配置** - 任何配置修改前先测试，避免影响关键服务
4. **备份配置** - 修改前备份重要配置文件

## 快速恢复脚本（可选）

如果经常需要恢复，可以创建脚本：

```bash
#!/bin/bash
# 保存为 restore.sh

echo "停止 nginx..."
sudo systemctl stop nginx 2>/dev/null
sudo systemctl disable nginx 2>/dev/null

echo "重启 SSH..."
sudo systemctl restart ssh || sudo systemctl restart sshd

echo "重启 FNOS..."
sudo systemctl restart fnos

echo "检查服务状态..."
sudo systemctl status ssh || sudo systemctl status sshd
netstat -tlnp | grep -E "22|5666"

echo "完成！"
```

使用方法：
```bash
chmod +x restore.sh
./restore.sh
```


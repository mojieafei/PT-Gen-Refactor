name: Build Worker Single File

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate package-lock.json if not exists
        run: |
          cd worker
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json not found, generating one..."
            npm install --package-lock-only
          else
            echo "package-lock.json found"
          fi

      - name: Install dependencies
        run: |
          cd worker
          npm ci

      - name: Create dist directory
        run: |
          cd worker
          mkdir -p dist

      - name: Build single file bundle
        run: |
          cd worker
          npx rollup -c

      - name: Create clean build branch with only bundle.js
        run: |
          # 创建一个临时目录来保存bundle.js
          mkdir -p /tmp/build
          cp worker/dist/bundle.js /tmp/build/bundle.js
          
          # 删除远程的build分支（如果存在）
          git push origin --delete build 2>/dev/null || echo "No remote build branch to delete"
          
          # 创建一个孤立的build分支
          git checkout --orphan build
          
          # 清理工作目录
          git rm -rf --cached . 2>/dev/null || true
          
          # 从临时目录复制bundle.js到工作目录
          cp /tmp/build/bundle.js .
          
          # 添加bundle.js到git
          git add bundle.js
          
          # 提交
          git -c user.name='github-actions[bot]' -c user.email='github-actions[bot]@users.noreply.github.com' commit -m "Auto-build: Single file bundle"
          
          # 推送到远程
          git push -u origin build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: worker-bundle
          path: worker/dist/bundle.js